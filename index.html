<!doctype html>
<html lang="vi" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WW1 - Hành Trình Sinh Động & Chi Tiết</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Be Vietnam Pro', sans-serif; user-select: none; }
    .game-canvas { image-rendering: pixelated; cursor: none; background: #0c0c14; }
    
    .btn-military {
      background: linear-gradient(180deg, #5d4e37 0%, #3d3225 100%);
      border: 3px solid #2a2318; color: #f3e5ab;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.2), 0 4px 0 #1a1510;
      transition: all 0.1s; font-weight: bold;
    }
    .btn-military:hover { transform: translateY(-2px); filter: brightness(1.1); }
    .telegram { background: #fdf5e6; border: 2px solid #5d4e37; position: relative; }
    #game-container { width: 800px; height: 450px; overflow: hidden; border: 8px solid #2a2318; border-radius: 12px; position: relative; background: #000; margin: auto; }
    
    #player-question-bubble {
        position: absolute; background: rgba(255, 255, 255, 0.95); border: 3px solid #3d3225;
        padding: 12px 20px; border-radius: 20px; max-width: 350px; font-weight: 800; font-size: 14px;
        color: #1a1510; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 25; pointer-events: none;
    }
    
    @keyframes loading { 0% { width: 0%; } 100% { width: 100%; } }
    .screen-overlay { transition: opacity 0.5s ease-in-out; }
  </style>
 </head>
 <body class="h-full bg-stone-950 flex items-center justify-center p-4">
  <div id="game-container" class="relative shadow-[0_0_100px_rgba(0,0,0,1)]">
   <canvas id="gameCanvas" width="800" height="450" class="game-canvas"></canvas>
   
   <div id="player-question-bubble" class="hidden" style="top: 40px; left: 80px;"></div>

   <div id="hud" class="absolute top-4 left-4 flex gap-4 pointer-events-none items-center z-10">
    <div class="bg-black/60 px-4 py-2 rounded-full border border-white/20 flex items-center gap-1 shadow-lg">
        <div id="hearts-container" class="flex text-red-500 text-xl"></div>
    </div>
    <div id="ammo-ui" class="hidden bg-black/60 px-4 py-2 rounded-full border border-amber-500/40 text-amber-400 font-black text-[10px] shadow-lg">
        GIAO TRANH: <span id="ammo-count">BẮN KẺ ĐỊCH CÓ ĐÁP ÁN ĐÚNG</span>
    </div>
   </div>
   <div id="level-display" class="absolute top-4 right-4 text-amber-200 text-[10px] font-black pointer-events-none bg-black/60 px-4 py-2 rounded border border-white/20 z-10 tracking-[0.2em] uppercase"></div>

   <!-- Question Popup -->
   <div id="question-popup" class="absolute inset-0 flex items-center justify-center hidden bg-black/70 backdrop-blur-md z-20">
    <div class="telegram p-6 max-w-sm mx-4 transform shadow-2xl border-4 border-double border-stone-800">
     <div class="text-[9px] text-stone-500 mb-2 uppercase tracking-tighter italic font-bold">Điện tín hỏa tốc</div>
     <p id="question-text" class="text-stone-900 text-base font-bold mb-4 leading-tight border-b-2 border-stone-300 pb-3"></p>
     <div id="answers" class="grid grid-cols-1 gap-2"></div>
     <div id="feedback-container" class="hidden mt-4 border-t-2 border-stone-300 pt-3">
         <p id="feedback" class="text-center text-sm font-black uppercase mb-1"></p>
         <p id="explanation" class="text-stone-700 text-[10px] italic text-center mb-4 leading-relaxed"></p>
         <button id="next-q-btn" class="btn-military w-full py-2 text-[10px] uppercase tracking-widest">Tiếp tục hành quân</button>
     </div>
    </div>
   </div>

   <!-- Negotiate Popup (Màn 3) -->
   <div id="negotiate-popup" class="absolute inset-0 flex items-center justify-center hidden bg-black/70 backdrop-blur-md z-20">
    <div class="telegram p-8 max-w-xl mx-4 transform shadow-2xl border-double border-8 border-stone-600">
     <h3 class="text-center text-stone-800 font-black mb-4 border-b-2 border-stone-400 uppercase text-xl">Báo Cáo Đại Tướng</h3>
     <p id="negotiate-text" class="text-stone-900 text-lg font-bold mb-4 italic text-center"></p>
     <div class="mb-6">
         <textarea id="negotiate-input" class="bg-stone-100 border-2 border-stone-400 h-24 p-4 text-center text-lg w-full outline-none focus:border-stone-600" placeholder="Viết câu trả lời..."></textarea>
     </div>
     <button id="submit-negotiate" class="btn-military w-full py-4 uppercase tracking-widest font-black text-lg">Gửi Báo Cáo</button>
    </div>
   </div>

   <!-- Screen Overlays -->
   <div id="transition-screen" class="absolute inset-0 bg-black flex items-center justify-center hidden z-40 screen-overlay">
       <div class="text-center">
           <h2 id="transition-title" class="text-white text-5xl font-black italic text-amber-500 mb-6"></h2>
           <div class="w-64 h-2 bg-stone-900 mx-auto rounded-full overflow-hidden border border-white/10">
               <div class="h-full bg-amber-600 animate-[loading_2s_ease-in-out_infinite]"></div>
           </div>
       </div>
   </div>

   <div id="victory-screen" class="absolute inset-0 bg-stone-950 flex flex-col items-center justify-center hidden z-50">
       <h1 class="text-amber-500 text-7xl font-black mb-2">KHẢI HOÀN</h1>
       <p class="text-stone-400 uppercase tracking-[0.5em] text-sm mb-8">Hòa bình đã lập lại trên toàn thế giới</p>
       <button onclick="location.reload()" class="btn-military px-16 py-4 text-xl">TRỞ VỀ THÀNH PHỐ</button>
   </div>

   <div id="gameover-screen" class="absolute inset-0 bg-red-950/90 flex flex-col items-center justify-center hidden z-50 backdrop-blur-lg">
       <h1 class="text-white text-7xl font-black mb-6">HY SINH</h1>
       <button onclick="location.reload()" class="btn-military bg-red-800 border-red-950 px-16 py-5 text-2xl">THỬ LẠI CHIẾN DỊCH</button>
   </div>

   <div id="start-screen" class="absolute inset-0 bg-[radial-gradient(circle_at_center,_#3e2b1f_0%,_#0c0c0c_100%)] flex flex-col items-center justify-center z-30">
    <div class="relative mb-12 text-center">
        <h1 class="text-amber-600 text-8xl font-black drop-shadow-[0_10px_10px_rgba(0,0,0,0.8)]">WW1</h1>
        <h2 class="text-amber-100 text-2xl font-black tracking-[0.4em] uppercase mt-[-10px]">Hành Trình Chi Tiết</h2>
    </div>
    <button id="start-btn" class="btn-military px-24 py-8 text-3xl uppercase">Bắt đầu sứ mệnh</button>
   </div>

   <div id="custom-cursor" class="fixed pointer-events-none w-16 h-16 hidden z-50">
        <svg viewBox="0 0 40 40" class="w-full h-full stroke-red-500 fill-none stroke-[2]">
            <circle cx="20" cy="20" r="15" opacity="0.4" stroke-dasharray="4 2"/>
            <line x1="20" x2="20" y2="10" /><line x1="20" y1="30" x2="20" y2="40" />
            <line x1="0" y1="20" x2="10" y2="20" /><line x1="30" y1="20" x2="40" y2="20" />
            <circle cx="20" cy="20" r="1.5" fill="red" stroke="none"/>
        </svg>
   </div>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const cursor = document.getElementById('custom-cursor');

    const audioManager = {
        ctx: null, mainGain: null, bgmInterval: null,
        init() {
            if (this.ctx) return;
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.mainGain = this.ctx.createGain(); this.mainGain.connect(this.ctx.destination);
            this.mainGain.gain.value = 0.3;
        },
        playDrum(time, type = 'snare') {
            const noise = this.ctx.createBufferSource();
            const buffer = this.ctx.createBuffer(1, this.ctx.sampleRate * 0.1, this.ctx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < buffer.length; i++) data[i] = Math.random() * 2 - 1;
            noise.buffer = buffer;
            const noiseFilter = this.ctx.createBiquadFilter(); noiseFilter.type = 'highpass';
            noiseFilter.frequency.value = type === 'snare' ? 1000 : 100;
            const noiseGain = this.ctx.createGain(); noiseGain.gain.setValueAtTime(type === 'snare' ? 0.1 : 0.2, time);
            noiseGain.gain.exponentialRampToValueAtTime(0.01, time + 0.1);
            noise.connect(noiseFilter); noiseFilter.connect(noiseGain); noiseGain.connect(this.mainGain); noise.start(time);
        },
        playNote(freq, startTime, duration, type = 'triangle') {
            const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, startTime);
            gain.gain.setValueAtTime(0, startTime); gain.gain.linearRampToValueAtTime(0.15, startTime + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
            osc.connect(gain); gain.connect(this.mainGain); osc.start(startTime); osc.stop(startTime + duration);
        },
        playBGM(type) {
            if (!this.ctx) return; if (this.bgmInterval) clearInterval(this.bgmInterval);
            let beat = 0;
            if (type === 'war') {
                const warMelody = [110, 110, 123, 130]; 
                this.bgmInterval = setInterval(() => {
                    const now = this.ctx.currentTime;
                    this.playDrum(now, 'snare');
                    if (beat % 4 === 0) this.playDrum(now, 'kick');
                    if (beat % 2 === 0) this.playNote(warMelody[(beat/2)%4], now, 0.4, 'sawtooth');
                    beat++;
                }, 200);
            } else {
                const peaceMelody = [261, 329, 392, 523];
                this.bgmInterval = setInterval(() => {
                    const now = this.ctx.currentTime;
                    if (beat % 4 === 0) this.playNote(peaceMelody[(beat/4)%4], now, 1.5, 'sine');
                    beat++;
                }, 400);
            }
        },
        playEffect(effect) {
            if (!this.ctx) return; const now = this.ctx.currentTime;
            if (effect === 'gunshot') { this.playDrum(now, 'kick'); }
            else if (effect === 'correct') { this.playNote(523, now, 0.1, 'sine'); this.playNote(659, now + 0.1, 0.3, 'sine'); }
            else if (effect === 'wrong') { this.playNote(220, now, 0.2, 'sawtooth'); this.playNote(110, now + 0.1, 0.4, 'sawtooth'); }
        }
    };

    let gameState = {
        active: false, level: 1, lives: 5, scrollX: 0, animFrame: 0, currentQuestion: 0,
        autoSpeed: 3.5, 
        player: { x: 130, y: 285, eyeTimer: 0, walkCycle: 0 },
        enemies: [], muzzleFlash: 0, 
        particles: Array.from({length: 30}, () => ({ x: Math.random()*800, y: Math.random()*450, s: Math.random()*1.5+0.5, op: Math.random() })),
        clouds: Array.from({length: 6}, () => ({ x: Math.random() * 2000, y: 30 + Math.random() * 80, speed: 0.2 + Math.random()*0.3, w: 100 + Math.random()*50 })),
        mountains: Array.from({length: 4}, (_, i) => ({ x: i * 300, w: 400 + Math.random()*200, h: 150 + Math.random()*100, color: '#1e2b3d' })),
        decor: Array.from({length: 80}, (_, i) => {
            const types = ['grass', 'stone', 'wire', 'ammo', 'broken_rifle'];
            return { 
                x: i * 120 + Math.random() * 60, 
                type: types[Math.floor(Math.random() * types.length)],
                rotation: Math.random() * Math.PI
            };
        }),
        trenches: [{ x: 1200, triggered: false }, { x: 2500, triggered: false }, { x: 3800, triggered: false }, { x: 5100, triggered: false }, { x: 6400, triggered: false }],
        questions: [
            { q: "Mâu thuẫn chủ yếu dẫn đến cuộc chiến này là gì?", a: ["Tranh chấp thuộc địa", "Khác biệt tôn giáo", "Tranh giành nguồn nước"], correct: 0, explanation: "Sự phát triển không đều khiến các đế quốc mâu thuẫn gắt gao về thị trường và thuộc địa." },
            { q: "Phe Hiệp ước bao gồm những cường quốc nào?", a: ["Đức, Áo-Hung, Ý", "Anh, Pháp, Nga", "Mỹ, Nhật, Trung Quốc"], correct: 1, explanation: "Khối Hiệp ước (Triple Entente) gồm Anh, Pháp, Nga đối đầu với phe Liên minh." },
            { q: "Ngòi nổ trực tiếp của cuộc chiến là vụ ám sát ở đâu?", a: ["Béc-lin", "Luân Đôn", "Xê-ra-vê-ô (Xéc-bi)"], correct: 2, explanation: "Thái tử Áo-Hung bị ám sát tại Sarajevo là ngòi nổ bùng nổ chiến tranh." },
            { q: "Cuộc chiến này mang tính chất gì?", a: ["Chính nghĩa", "Phi nghĩa (Đế quốc)", "Tự vệ dân tộc"], correct: 1, explanation: "Đây là cuộc chiến tranh tranh giành quyền lợi của các đế quốc, gây đau khổ cho nhân dân." },
            { q: "Vũ khí mới nào được dùng lần đầu trong WW1?", a: ["Hơi độc & Xe tăng", "Bom nguyên tử", "Máy bay phản lực"], correct: 0, explanation: "Hơi độc và xe tăng là những công nghệ mới xuất hiện gây kinh hoàng trên chiến trường." }
        ],
        level2Questions: [
            { q: "Sự kiện nào ở Nga năm 1917 làm thay đổi cục diện?", a: ["Cách mạng tháng Mười", "Nga đầu hàng Đức"], correct: 0, explanation: "Cách mạng thành công đưa nước Nga rút khỏi chiến tranh." },
            { q: "Năm 1917, vì sao Mỹ quyết định tham gia chiến tranh?", a: ["Bảo vệ hòa bình", "Bảo vệ quyền lợi kinh tế"], correct: 1, explanation: "Mỹ tham chiến để đảm bảo vị thế và kinh tế khi cục diện đã rõ." },
            { q: "Chiến thuật tác chiến đặc trưng nhất của WW1 là gì?", a: ["Chiến tranh hầm hào", "Tác chiến cơ động"], correct: 0, explanation: "Hệ thống chiến hào khổng lồ khiến cuộc chiến giằng co đẫm máu." },
            { q: "Đế quốc nào được coi là hung hăng và là thủ phạm chính gây chiến?", a: ["Đế quốc Anh", "Đế quốc Đức", "Nước Pháp"], correct: 1, explanation: "Đức là kẻ đòi chia lại bản đồ thế giới mạnh mẽ nhất bằng vũ lực." },
            { q: "Hậu quả nặng nề nhất về nhân mạng của Thế chiến I là gì?", a: ["10 triệu người chết", "Mất hết tài sản", "Thế giới chia làm hai"], correct: 0, explanation: "Cuộc chiến gây ra tổn thất kinh khủng về người, làm suy yếu toàn bộ châu Âu." }
        ],
        level3Questions: [
            { q: "Tướng quân: 'Tính chất cuối cùng của cuộc chiến này là gì?'", keywords: ["phi nghĩa", "xâm lược", "đế quốc"] },
            { q: "Tướng quân: 'Điều gì đã giúp Nga rút khỏi cuộc chiến này sớm?'", keywords: ["cách mạng", "tháng mười", "10"] }
        ],
        showQuestion: false, transitioning: false, officerMet: false, gameOver: false
    };

    function update() {
        if (!gameState.active || gameState.showQuestion || gameState.transitioning || gameState.gameOver) return;
        
        gameState.animFrame += 0.15;
        gameState.player.eyeTimer++;
        gameState.player.walkCycle += 0.2;
        if(gameState.muzzleFlash > 0) gameState.muzzleFlash--;
        gameState.scrollX += gameState.autoSpeed;

        // Cập nhật mây
        gameState.clouds.forEach(c => {
            c.x -= c.speed;
            if(c.x + c.w < 0) c.x = 2000;
        });

        // Cập nhật hạt bụi
        gameState.particles.forEach(p => {
            p.x -= 0.5; if(p.x < 0) p.x = 800;
        });

        if (gameState.level === 1) {
            gameState.trenches.forEach((t, i) => {
                if(!t.triggered && (gameState.scrollX + gameState.player.x) > t.x) { 
                    t.triggered = true; gameState.currentQuestion = i; triggerQuestion(); 
                }
            });
            if (gameState.scrollX > 7500) { 
                triggerTransition("MÀN 2: TRẬN ĐÁNH TƯ DUY", () => {
                    gameState.level = 2; gameState.currentQuestion = 0; gameState.scrollX = 0;
                    document.getElementById('ammo-ui').classList.remove('hidden');
                    document.getElementById('player-question-bubble').classList.remove('hidden');
                });
            }
        } 
        else if (gameState.level === 2) {
            const currentQ = gameState.level2Questions[gameState.currentQuestion];
            if(currentQ) {
                document.getElementById('player-question-bubble').textContent = currentQ.q;
                if (gameState.enemies.length === 0) {
                    currentQ.a.forEach((ans, i) => {
                        gameState.enemies.push({ x: 900 + (i * 350), y: 285, answerIndex: i, text: ans, label: String.fromCharCode(65+i), dead: false });
                    });
                }
            } else {
                document.getElementById('player-question-bubble').classList.add('hidden');
                triggerTransition("MÀN 3: HIỆP ƯỚC HÒA BÌNH", () => {
                    gameState.level = 3; gameState.scrollX = 0; gameState.currentQuestion = 0;
                    document.getElementById('ammo-ui').classList.add('hidden');
                    audioManager.playBGM('peace');
                });
            }

            gameState.enemies.forEach((en, i) => {
                if(!en.dead) { en.x -= 2.0; if(en.x < 50) { gameState.enemies = []; gameState.lives--; audioManager.playEffect('wrong'); if(gameState.lives <= 0) endGame(); } }
                else { en.y += 15; if(en.y > 500) gameState.enemies.splice(i, 1); }
            });
        }
        else if (gameState.level === 3 && !gameState.officerMet) {
            if(gameState.scrollX >= 400) { gameState.officerMet = true; gameState.autoSpeed = 0; triggerNegotiate(); }
        }
        updateHUD();
    }

    function triggerQuestion() {
        gameState.showQuestion = true;
        const q = gameState.questions[gameState.currentQuestion];
        document.getElementById('question-popup').classList.remove('hidden');
        document.getElementById('question-text').textContent = q.q;
        const container = document.getElementById('answers'); container.innerHTML = '';
        document.getElementById('feedback-container').classList.add('hidden');
        q.a.forEach((a, i) => {
            const b = document.createElement('button');
            b.className = "btn-military py-2 px-4 mb-2 w-full text-left text-xs"; b.textContent = a;
            b.onclick = () => {
                const ok = i === q.correct;
                document.getElementById('feedback-container').classList.remove('hidden');
                document.getElementById('feedback').textContent = ok ? "CHÍNH XÁC!" : "SAI RỒI!";
                document.getElementById('feedback').className = ok ? "text-center font-black text-green-700" : "text-center font-black text-red-700";
                document.getElementById('explanation').textContent = q.explanation;
                if(ok) audioManager.playEffect('correct'); else { audioManager.playEffect('wrong'); gameState.lives--; if(gameState.lives<=0) endGame(); }
                document.getElementById('next-q-btn').onclick = () => { gameState.showQuestion = false; document.getElementById('question-popup').classList.add('hidden'); };
            };
            container.appendChild(b);
        });
    }

    function triggerNegotiate() {
        const q = gameState.level3Questions[gameState.currentQuestion];
        if(!q) { document.getElementById('negotiate-popup').classList.add('hidden'); document.getElementById('victory-screen').classList.remove('hidden'); return; }
        document.getElementById('negotiate-popup').classList.remove('hidden');
        document.getElementById('negotiate-text').textContent = q.q;
        document.getElementById('negotiate-input').value = "";
    }

    document.getElementById('submit-negotiate').onclick = () => {
        const input = document.getElementById('negotiate-input').value.toLowerCase();
        const q = gameState.level3Questions[gameState.currentQuestion];
        if(q.keywords.some(k => input.includes(k))) { audioManager.playEffect('correct'); gameState.currentQuestion++; triggerNegotiate(); }
        else { audioManager.playEffect('wrong'); gameState.lives--; if(gameState.lives<=0) endGame(); }
    };

    function endGame() { gameState.gameOver = true; document.getElementById('gameover-screen').classList.remove('hidden'); }

    function draw() {
        ctx.clearRect(0,0,800,450);
        
        // Sky
        const skyGrad = ctx.createLinearGradient(0,0,0,450);
        skyGrad.addColorStop(0, '#0a0a14'); skyGrad.addColorStop(1, '#1a1a2e');
        ctx.fillStyle = skyGrad; ctx.fillRect(0,0,800,450);

        // Mountains (Parallax)
        gameState.mountains.forEach((m, i) => {
            const mx = (m.x - gameState.scrollX * 0.1) % 1200;
            ctx.fillStyle = m.color;
            ctx.beginPath();
            ctx.moveTo(mx, 350);
            ctx.lineTo(mx + m.w / 2, 350 - m.h);
            ctx.lineTo(mx + m.w, 350);
            ctx.fill();
            // Đỉnh núi phủ tuyết nhẹ
            ctx.fillStyle = '#2c3e50';
            ctx.beginPath();
            ctx.moveTo(mx + m.w / 2, 350 - m.h);
            ctx.lineTo(mx + m.w / 2 - 30, 350 - m.h + 40);
            ctx.lineTo(mx + m.w / 2 + 30, 350 - m.h + 40);
            ctx.fill();
        });

        // Clouds
        ctx.fillStyle = 'rgba(255,255,255,0.05)';
        gameState.clouds.forEach(c => {
            ctx.beginPath();
            ctx.ellipse(c.x, c.y, c.w, c.w/3, 0, 0, Math.PI*2);
            ctx.fill();
        });

        // Floor
        ctx.fillStyle = '#1c140d'; ctx.fillRect(0, 350, 800, 100);
        ctx.fillStyle = '#2d1e12'; ctx.fillRect(0, 350, 800, 4);

        // Decor (Chi tiết hơn)
        gameState.decor.forEach(d => {
            const dx = d.x - gameState.scrollX;
            if(dx > -100 && dx < 900) {
                ctx.save();
                ctx.translate(dx, 350);
                if(d.type === 'grass') {
                    ctx.strokeStyle = '#2d3a1a'; ctx.lineWidth = 2;
                    ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-3,-10); ctx.moveTo(0,0); ctx.lineTo(3,-12); ctx.stroke();
                } else if(d.type === 'stone') {
                    ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(0, -2, 4, 0, 7); ctx.fill();
                } else if(d.type === 'wire') {
                    ctx.strokeStyle = '#444'; ctx.lineWidth = 1;
                    ctx.beginPath(); 
                    for(let i=0; i<3; i++) ctx.arc(i*10, -5, 8, 0, Math.PI); 
                    ctx.stroke();
                } else if(d.type === 'ammo') {
                    ctx.fillStyle = '#b8860b'; ctx.fillRect(0, -2, 6, 2);
                } else if(d.type === 'broken_rifle') {
                    ctx.fillStyle = '#3d2b1f'; ctx.fillRect(0, -3, 15, 3);
                    ctx.fillStyle = '#111'; ctx.fillRect(15, -3, 10, 2);
                }
                ctx.restore();
            }
        });

        // Trenches
        gameState.trenches.forEach(t => {
            const tx = t.x - gameState.scrollX;
            if(tx > -150 && tx < 850) {
                ctx.fillStyle = '#050505'; ctx.fillRect(tx, 350, 150, 100);
                // Gia cố bằng gỗ
                ctx.fillStyle = '#2a1a0a'; ctx.fillRect(tx, 350, 5, 100); ctx.fillRect(tx+145, 350, 5, 100);
            }
        });

        // Hạt bụi
        ctx.fillStyle = 'rgba(255,255,255,0.1)';
        gameState.particles.forEach(p => {
            ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, 7); ctx.fill();
        });

        // Characters
        drawSoldier(gameState.player.x, gameState.player.y, '#4b5320', false, gameState.level === 2);
        
        if(gameState.level === 2) {
            gameState.enemies.forEach(en => {
                drawSoldier(en.x, en.y, '#3e4444', true);
                ctx.fillStyle = 'white'; ctx.font = 'bold 16px Be Vietnam Pro'; ctx.textAlign='center';
                ctx.fillText(en.label, en.x-40, en.y-45);
            });
        } else if(gameState.level === 3) {
            drawOfficer(650, 270);
        }

        update();
        requestAnimationFrame(draw);
    }

    function drawSoldier(x, y, color, isEnemy, shooting) {
        const bounce = Math.sin(gameState.animFrame) * 3;
        const blink = (gameState.player.eyeTimer % 180 < 10);
        
        ctx.save(); ctx.translate(x, y + bounce);
        if(isEnemy) ctx.scale(-1, 1);
        
        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.ellipse(15, 65 - bounce, 15, 5, 0, 0, 7); ctx.fill();

        // Chân (Legs)
        ctx.fillStyle = color;
        const legW = 8; const legH = 15;
        // Chân trái
        ctx.save(); ctx.translate(8, 45); ctx.rotate(isEnemy ? 0 : Math.sin(gameState.player.walkCycle) * 0.5);
        ctx.fillRect(-legW/2, 0, legW, legH); ctx.fillStyle='#111'; ctx.fillRect(-legW/2, legH-3, legW+2, 3);
        ctx.restore();
        // Chân phải
        ctx.fillStyle = color;
        ctx.save(); ctx.translate(22, 45); ctx.rotate(isEnemy ? 0 : Math.sin(gameState.player.walkCycle + Math.PI) * 0.5);
        ctx.fillRect(-legW/2, 0, legW, legH); ctx.fillStyle='#111'; ctx.fillRect(-legW/2, legH-3, legW+2, 3);
        ctx.restore();

        // Thân (Body) & Quân phục (Uniform)
        ctx.fillStyle = color; ctx.beginPath(); ctx.roundRect(0, 0, 30, 50, 5); ctx.fill();
        // Chi tiết quân phục
        ctx.strokeStyle = 'rgba(0,0,0,0.2)'; ctx.lineWidth = 1;
        ctx.strokeRect(5, 10, 8, 8); ctx.strokeRect(17, 10, 8, 8); // Túi ngực
        ctx.fillStyle = '#2a2a2a'; ctx.fillRect(0, 30, 30, 4); // Thắt lưng (Belt)
        
        // Đầu (Head)
        ctx.fillStyle = '#f5d6b4'; ctx.beginPath(); ctx.arc(15, -12, 14, 0, 7); ctx.fill();
        
        // Mũ bảo hiểm (Helmet)
        ctx.fillStyle = '#3d441a'; 
        ctx.beginPath(); ctx.arc(15, -16, 15, Math.PI, 0); ctx.fill();
        ctx.fillRect(0, -18, 30, 4); // Vành mũ

        // Mắt (Eyes)
        if(!blink) {
            ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(10, -12, 3, 0, 7); ctx.arc(20, -12, 3, 0, 7); ctx.fill();
            ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(11, -12, 1.5, 0, 7); ctx.arc(21, -12, 1.5, 0, 7); ctx.fill();
        }

        // Súng trường chi tiết (Rifle)
        ctx.save();
        ctx.translate(20, 20);
        if(shooting) ctx.rotate(-0.1);
        // Báng súng gỗ
        ctx.fillStyle = '#3d2b1f'; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-20, 10); ctx.lineTo(-20, 0); ctx.closePath(); ctx.fill();
        // Thân súng & nòng
        ctx.fillStyle = '#1a1a1a'; ctx.fillRect(0, 0, 50, 5); // Nòng súng dài
        ctx.fillRect(5, 5, 10, 5); // Ổ đạn
        
        if(shooting && !isEnemy && gameState.muzzleFlash > 0) {
            ctx.fillStyle = '#ffaa00'; ctx.beginPath(); ctx.arc(55, 2, 12, 0, 7); ctx.fill();
            ctx.fillStyle = '#ffffff'; ctx.beginPath(); ctx.arc(55, 2, 6, 0, 7); ctx.fill();
        }
        ctx.restore();
        
        ctx.restore();
    }

    function drawOfficer(x, y) {
        const bounce = Math.sin(gameState.animFrame * 0.5) * 2;
        ctx.save(); ctx.translate(x, y + bounce);
        // Quân phục đại lễ
        ctx.fillStyle = '#0d1b3e'; ctx.beginPath(); ctx.roundRect(0, 0, 40, 70, 8); ctx.fill();
        ctx.fillStyle = '#ffd700'; ctx.fillRect(-5, 5, 12, 6); ctx.fillRect(33, 5, 12, 6); // Cầu vai vàng
        ctx.fillStyle = '#c0392b'; ctx.fillRect(10, 15, 20, 2); // Dải huân chương đỏ
        
        ctx.fillStyle = '#f5d6b4'; ctx.beginPath(); ctx.arc(20, -20, 18, 0, 7); ctx.fill();
        ctx.fillStyle = '#0d1b3e'; ctx.beginPath(); ctx.ellipse(20, -32, 22, 8, 0, 0, Math.PI*2); ctx.fill(); // Mũ kê-pi
        ctx.restore();
    }

    function updateHUD() {
        const container = document.getElementById('hearts-container'); 
        if(container) container.innerHTML = '❤'.repeat(gameState.lives) + '<span class="opacity-20">❤</span>'.repeat(Math.max(0, 5-gameState.lives));
        const lvlDisp = document.getElementById('level-display');
        if(lvlDisp) lvlDisp.textContent = "CHIẾN DỊCH: CẤP " + gameState.level;
    }

    canvas.addEventListener('mousedown', (e) => {
        if(gameState.level === 2 && !gameState.showQuestion) {
            audioManager.init(); // Đảm bảo âm thanh được kích hoạt khi click
            audioManager.playEffect('gunshot'); gameState.muzzleFlash = 3; 
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left) * (800 / rect.width);
            const currentQ = gameState.level2Questions[gameState.currentQuestion];
            if(!currentQ) return;
            gameState.enemies.forEach(en => {
                if(!en.dead && Math.abs(mx - en.x) < 80) {
                    if (en.answerIndex === currentQ.correct) { 
                        en.dead = true; audioManager.playEffect('correct');
                        setTimeout(() => { gameState.enemies = []; gameState.currentQuestion++; }, 600);
                    } else { audioManager.playEffect('wrong'); en.dead = true; gameState.lives--; if(gameState.lives <= 0) endGame(); }
                }
            });
        }
    });

    document.getElementById('start-btn').onclick = () => { 
        audioManager.init(); audioManager.playBGM('war');
        document.getElementById('start-screen').classList.add('hidden'); gameState.active = true; 
    };

    window.addEventListener('mousemove', (e) => {
        if(cursor) {
            cursor.style.left = e.clientX - 32 + 'px'; cursor.style.top = e.clientY - 32 + 'px';
            if(gameState.level === 2) cursor.classList.remove('hidden'); else cursor.classList.add('hidden');
        }
    });

    function triggerTransition(title, callback) {
        gameState.transitioning = true; const screen = document.getElementById('transition-screen');
        document.getElementById('transition-title').textContent = title; screen.classList.remove('hidden'); screen.style.opacity = 1;
        setTimeout(() => { callback(); setTimeout(() => { screen.style.opacity = 0; setTimeout(() => { screen.classList.add('hidden'); gameState.transitioning = false; }, 500); }, 1000); }, 2000);
    }

    // Khởi động vòng lặp vẽ
    requestAnimationFrame(draw);
  </script>
 </body>
</html>
